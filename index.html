<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Užimtumo Robotas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- PRISIJUNGIMO VAIZDAS -->
        <div id="login-view" class="flex-1 flex items-center justify-center p-8">
            <div class="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl p-12 border border-slate-100">
                <div class="flex flex-col items-center mb-12 text-center">
                    <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tighter font-sans">Prisijungimas</h1>
                </div>
                <form id="login-form" class="space-y-6">
                    <div class="relative group">
                        <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-600 w-5 h-5"></i>
                        <input type="text" id="username" placeholder="Vartotojas" required
                            class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-50/50 outline-none transition-all font-bold text-slate-700 placeholder:text-slate-300 font-sans">
                    </div>
                    <div class="relative group">
                        <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-600 w-5 h-5"></i>
                        <input type="password" id="password" placeholder="Slaptažodis" required
                            class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-50/50 outline-none transition-all font-bold text-slate-700 placeholder:text-slate-300 font-sans">
                    </div>
                    <div id="login-error" class="hidden text-red-500 text-[10px] font-black uppercase text-center tracking-widest animate-pulse font-mono">
                        Neteisingi duomenys
                    </div>
                    <button type="submit" class="w-full bg-slate-900 hover:bg-black text-white font-black py-5 rounded-2xl shadow-xl uppercase tracking-widest text-xs transition-all active:scale-95 font-sans">
                        Prisijungti
                    </button>
                </form>
            </div>
        </div>

        <!-- PAGRINDINIS VAIZDAS -->
        <div id="main-view" class="hidden flex-1 flex h-screen overflow-hidden bg-white">
            <!-- ADMIN ŠONINIS MENIU -->
            <aside id="admin-sidebar" class="hidden w-72 bg-slate-900 text-slate-400 p-8 flex flex-col border-r border-slate-800 shadow-2xl overflow-y-auto">
                <div class="flex items-center gap-4 text-white mb-10 px-2">
                    <div class="p-2 bg-blue-600 rounded-xl shadow-lg shadow-blue-500/20"><i data-lucide="database" class="w-6 h-6"></i></div>
                    <span class="font-black text-xl tracking-tighter uppercase italic text-white/90 font-sans">Admin</span>
                </div>
                <nav class="space-y-1 flex-1 text-left">
                    <div class="text-[10px] font-black text-slate-600 uppercase tracking-[0.2em] mb-4 px-4 font-sans">Duomenų bazės</div>
                    <button onclick="switchAdminTab('static_db')" class="admin-tab-btn w-full flex items-center gap-3 p-4 rounded-2xl transition-all hover:bg-slate-800/50 font-sans text-left" data-tab="static_db">
                        <i data-lucide="table" class="w-4 h-4"></i> Statika
                    </button>
                    <button onclick="switchAdminTab('led_db')" class="admin-tab-btn w-full flex items-center gap-3 p-4 rounded-2xl transition-all hover:bg-slate-800/50 font-sans text-left" data-tab="led_db">
                        <i data-lucide="monitor" class="w-4 h-4"></i> LED Ekranai
                    </button>
                    <div class="text-[10px] font-black text-slate-600 uppercase tracking-[0.2em] mt-10 mb-4 px-4 font-sans text-left">Eksporto šablonai</div>
                    <button onclick="switchAdminTab('static_template')" class="admin-tab-btn w-full flex items-center gap-3 p-4 rounded-2xl transition-all hover:bg-slate-800/50 font-sans text-left" data-tab="static_template">
                        <i data-lucide="settings" class="w-4 h-4"></i> Statikos šablonas
                    </button>
                    <button onclick="switchAdminTab('led_template')" class="admin-tab-btn w-full flex items-center gap-3 p-4 rounded-2xl transition-all hover:bg-slate-800/50 font-sans text-left" data-tab="led_template">
                        <i data-lucide="settings" class="w-4 h-4"></i> LED šablonas
                    </button>
                </nav>
                <button onclick="handleLogout()" class="flex items-center gap-3 p-4 text-slate-500 hover:text-red-400 transition-colors border-t border-slate-800 mt-6 w-full text-left font-bold uppercase text-xs tracking-widest font-sans font-sans font-sans">
                    <i data-lucide="log-out" class="w-5 h-5 font-sans"></i> Atsijungti
                </button>
            </aside>

            <!-- TURINYS -->
            <main class="flex-1 flex flex-col h-screen overflow-y-auto bg-slate-50 font-sans">
                
                <!-- USER FLOW -->
                <div id="user-flow" class="hidden flex-1 flex flex-col items-center justify-center p-8">
                    <div class="w-full max-w-4xl">
                        <!-- PROGRESO JUOSTA -->
                        <div class="mb-20 flex justify-between relative px-10 font-sans">
                            <div class="absolute top-6 left-16 right-16 h-0.5 bg-slate-200 z-0"></div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="1">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-blue-600 text-white shadow-xl ring-4 ring-white">1</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-blue-600">Tipas</span>
                            </div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="2">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300">2</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-300">Data</span>
                            </div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="3">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300">3</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-300">Įkelti</span>
                            </div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300">4</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-300">Formuoti</span>
                            </div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="5">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300">5</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-300 font-sans">Sėkmė</span>
                            </div>
                        </div>

                        <!-- KORTELĖ -->
                        <div class="bg-white rounded-[4rem] shadow-2xl p-16 md:p-24 min-h-[550px] flex flex-col border border-slate-100 relative overflow-hidden text-center font-sans">
                            
                            <!-- 1 ŽINGSNIS: TIPAS -->
                            <div id="step-1" class="wizard-step animate-in fade-in slide-in-from-bottom-12 duration-700 flex flex-col justify-center flex-1">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 text-center font-sans">
                                    <button onclick="setSelection('type', 'Statika')" class="type-btn p-14 rounded-[3rem] border-4 transition-all flex flex-col items-center justify-center gap-6 group hover:border-blue-100 bg-slate-50/50" data-type="Statika">
                                        <i data-lucide="file-spreadsheet" class="w-14 h-14 text-slate-200 group-hover:text-blue-600 transition-colors"></i>
                                        <span class="font-black text-3xl uppercase tracking-tighter text-slate-300 group-hover:text-blue-700 font-sans">Statika</span>
                                    </button>
                                    <button onclick="setSelection('type', 'LED')" class="type-btn p-14 rounded-[3rem] border-4 transition-all flex flex-col items-center justify-center gap-6 group hover:border-blue-100 bg-slate-50/50" data-type="LED">
                                        <i data-lucide="monitor" class="w-14 h-14 text-slate-200 group-hover:text-blue-600 transition-colors"></i>
                                        <span class="font-black text-3xl uppercase tracking-tighter text-slate-300 group-hover:text-blue-700 font-sans">LED</span>
                                    </button>
                                </div>
                            </div>

                            <!-- 2 ŽINGSNIS: DATA -->
                            <div id="step-2" class="wizard-step hidden animate-in fade-in slide-in-from-right-12 duration-700 flex flex-col justify-center flex-1 text-center font-sans">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10 text-center font-sans">
                                    <button onclick="setDateMode('auto')" class="date-mode-btn p-10 rounded-[2.5rem] border-4 flex flex-col items-center justify-center transition-all bg-slate-50 border-slate-50 text-slate-300 hover:border-blue-100 shadow-sm" id="btn-auto">
                                        <i data-lucide="refresh-ccw" class="w-8 h-8 mb-4"></i>
                                        <span class="font-black text-xl uppercase tracking-tighter font-sans">3 mėn nuo šiandien</span>
                                    </button>
                                    <button onclick="setDateMode('custom')" class="date-mode-btn p-10 rounded-[2.5rem] border-4 flex flex-col items-center justify-center transition-all bg-slate-50 border-slate-50 text-slate-300 hover:border-blue-100 shadow-sm font-sans" id="btn-custom">
                                        <i data-lucide="calendar" class="w-8 h-8 mb-4 font-sans"></i>
                                        <span class="font-black text-xl uppercase tracking-tighter font-sans">Pasirinkti intervalą</span>
                                    </button>
                                </div>
                                <div class="p-10 bg-slate-50 rounded-[3rem] grid grid-cols-2 gap-10 border border-slate-100 text-left font-sans">
                                    <div>
                                        <label class="text-[10px] font-black text-slate-400 uppercase mb-4 block tracking-widest font-mono text-left font-sans">Pradžia (YYYY-MM-DD)</label>
                                        <input type="date" id="dateStart" class="date-input w-full bg-transparent border-b-2 outline-none text-2xl font-black py-2 transition-all border-slate-200 focus:border-blue-600 font-sans">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-black text-slate-400 uppercase mb-4 block tracking-widest font-mono text-left font-sans">Pabaiga (YYYY-MM-DD)</label>
                                        <input type="date" id="dateEnd" class="date-input w-full bg-transparent border-b-2 outline-none text-2xl font-black py-2 transition-all border-slate-200 focus:border-blue-600 font-sans">
                                    </div>
                                </div>
                            </div>

                            <!-- 3 ŽINGSNIS: ĮKELTI -->
                            <div id="step-3" class="wizard-step hidden animate-in fade-in slide-in-from-right-12 duration-700 flex-1 flex flex-col font-sans">
                                <h2 class="text-5xl font-black text-slate-900 mb-12 uppercase tracking-tighter font-sans">Įkelti failą</h2>
                                <div class="relative group border-4 border-dashed border-slate-100 rounded-[3.5rem] p-24 flex flex-col items-center justify-center bg-slate-50/50 hover:bg-white hover:border-blue-400 transition-all cursor-pointer flex-1 font-sans">
                                    <input type="file" id="file-input" class="absolute inset-0 opacity-0 cursor-pointer font-sans" accept=".xlsx">
                                    <div class="p-10 bg-white rounded-[2.5rem] shadow-xl mb-8 group-hover:scale-110 transition-transform text-blue-600 font-sans">
                                        <i data-lucide="file-up" class="w-16 h-16 font-sans"></i>
                                    </div>
                                    <p id="file-name" class="font-black text-slate-900 text-2xl tracking-tight font-sans">Nutempkite Excel failą čia</p>
                                </div>
                            </div>

                            <!-- 4 ŽINGSNIS: FORMUOTI -->
                            <div id="step-4" class="wizard-step hidden animate-in zoom-in duration-700 flex flex-col items-center justify-center flex-1 font-sans">
                                <div id="formuoti-prompt" class="flex flex-col items-center justify-center">
                                    <button onclick="startProcessing()" class="px-24 py-7 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-[2.5rem] shadow-2xl shadow-blue-200 uppercase tracking-widest text-sm transition-all active:scale-95 font-sans">Pradėti nuskaitymą</button>
                                </div>
                                <div id="processing-spinner" class="hidden">
                                    <div class="relative w-48 h-48 mx-auto mb-12 font-sans">
                                        <div class="w-full h-full border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
                                        <div class="absolute inset-0 flex items-center justify-center font-black text-blue-600 uppercase text-xs tracking-tighter font-mono italic font-sans">...</div>
                                    </div>
                                    <h3 class="text-3xl font-black text-slate-900 uppercase tracking-tighter font-sans">Vyksta nuskaitymas</h3>
                                    <p class="text-slate-400 mt-4 font-bold uppercase tracking-[0.2em] text-[10px] font-sans">Formuojamos duomenų eilutės...</p>
                                </div>
                            </div>

                            <!-- 5 ŽINGSNIS: SĖKMĖ -->
                            <div id="step-5" class="wizard-step hidden animate-in zoom-in duration-700 flex flex-col items-center justify-center flex-1 font-sans">
                                <div class="w-40 h-40 bg-green-500 text-white rounded-[3rem] flex items-center justify-center mb-12 shadow-2xl shadow-green-200 rotate-6 transition-transform">
                                    <i data-lucide="check-circle-2" class="w-24 h-24 font-sans"></i>
                                </div>
                                <h2 class="text-5xl font-black text-slate-900 mb-6 uppercase tracking-tighter font-sans">SUFORMUOTA</h2>
                                <p id="success-message" class="text-slate-500 mb-10 max-w-sm mx-auto font-medium leading-relaxed font-sans"></p>
                                <button onclick="resetWizard()" class="px-10 py-5 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest text-[10px] hover:bg-black transition-all flex items-center gap-3 mx-auto font-sans">
                                    <i data-lucide="refresh-ccw" class="w-4 h-4 font-sans"></i> Naujas nuskaitymas
                                </button>
                            </div>

                            <!-- NAVIGACIJA -->
                            <div id="wizard-nav" class="mt-auto pt-20 flex justify-between items-center border-t border-slate-50 font-sans">
                                <button onclick="changeStep(-1)" id="prev-btn" class="flex items-center gap-3 font-black uppercase tracking-widest text-xs text-slate-300 hover:text-slate-900 transition-colors invisible font-sans">
                                    <i data-lucide="arrow-left" class="w-6 h-6 font-sans"></i> Atgal
                                </button>
                                <div class="flex items-center gap-6 font-sans">
                                    <button onclick="handleLogout()" class="text-xs font-black text-slate-300 uppercase hover:text-red-500 transition-colors font-sans">Atšaukti</button>
                                    <button onclick="changeStep(1)" id="next-btn" class="bg-slate-900 hover:bg-black text-white font-black px-16 py-6 rounded-[2rem] flex items-center gap-4 shadow-2xl disabled:bg-slate-100 disabled:text-slate-200 transition-all uppercase tracking-widest text-xs font-sans">
                                        Toliau <i data-lucide="arrow-right" class="w-6 h-6 font-sans"></i>
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ADMIN PANELIS -->
                <div id="admin-panel" class="hidden p-12 space-y-16 max-w-7xl mx-auto w-full font-sans">
                    <header class="flex justify-between items-end border-b border-slate-100 pb-12 font-sans">
                        <div>
                            <h2 id="admin-title" class="text-6xl font-black text-slate-900 uppercase tracking-tighter font-sans">Duomenų bazė</h2>
                            <div class="flex items-center gap-4 mt-4 font-sans">
                                <span id="admin-badge" class="bg-blue-600 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-[0.2em] font-sans">STATIKA</span>
                                <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px] font-sans">Struktūros valdymas</p>
                            </div>
                        </div>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-5 rounded-2xl font-black uppercase tracking-widest text-[10px] shadow-xl shadow-blue-500/20 flex items-center gap-3 transition-all hover:-translate-y-1 active:scale-95 font-sans">
                            <i data-lucide="plus" class="w-5 h-5 font-sans"></i> Pridėti įrašą
                        </button>
                    </header>

                    <!-- DB LENTELĖ -->
                    <div id="admin-db-view" class="bg-white rounded-[3.5rem] border border-slate-100 shadow-2xl overflow-hidden font-sans">
                        <div class="p-10 bg-slate-50 flex items-center justify-between font-sans">
                            <div class="relative w-96 text-left font-sans">
                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5 font-sans"></i>
                                <input type="text" placeholder="Ieškoti..." class="w-full pl-12 pr-6 py-4 bg-white rounded-2xl border border-slate-200 outline-none text-sm font-medium transition-all font-sans font-sans">
                            </div>
                        </div>
                        <div class="overflow-x-auto font-sans">
                            <table class="w-full text-left border-collapse font-sans font-sans" id="db-table">
                                <!-- Dinaminis turinys -->
                            </table>
                        </div>
                    </div>

                    <!-- ŠABLONO VAIZDAS -->
                    <div id="admin-template-view" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-16 font-sans">
                        <div class="bg-white rounded-[4rem] p-16 border border-slate-100 shadow-2xl overflow-hidden font-sans">
                            <h3 class="text-3xl font-black text-slate-900 mb-10 uppercase tracking-tighter">Stulpelių tvarka</h3>
                            <div id="template-list" class="space-y-4 font-mono text-xs font-sans">
                                <!-- Dinaminis turinys -->
                            </div>
                        </div>
                        <div class="bg-slate-900 rounded-[4rem] p-16 text-white flex flex-col shadow-2xl relative border border-slate-800 font-sans">
                            <h3 class="text-3xl font-black mb-10 uppercase tracking-tighter text-blue-400 font-sans">Eksporto taisyklė</h3>
                            <div id="export-rule-text" class="bg-slate-800/40 rounded-[2.5rem] p-10 flex-1 border border-slate-800 italic text-sm text-slate-400 leading-relaxed font-medium font-sans font-sans">
                                <!-- Dinaminis tekstas -->
                            </div>
                            <button class="w-full mt-12 bg-blue-600 hover:bg-blue-700 py-7 rounded-[2.5rem] font-black uppercase tracking-widest text-[11px] transition-all shadow-xl shadow-blue-500/20 active:scale-95 font-sans">Išsaugoti pakeitimus</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let currentUser = null;
        let userStep = 1;
        let selection = {
            type: null,
            dateMode: 'auto',
            dateStart: formatDate(new Date()),
            dateEnd: '',
            file: null
        };

        const INITIAL_STATIC_DB = [
            { id: 1, statusas: 'OK', kodas: 'K101', miestas: 'Kaunas', adresas: 'Veiverių g. 13', tipas: 'Billboard' },
            { id: 2, statusas: 'OK', kodas: 'V205', miestas: 'Vilnius', adresas: 'Geležinio Vilko g.', tipas: 'Bigboard' },
        ];

        const INITIAL_LED_DB = [
            { id: 1, statusas: 'Live', kodas: 'LED-V1', ekranas: 'Panorama LED', adresas: 'Saltoniškių g. 9', rezoliucija: '1920x1080', darboLaikas: '08:00 - 22:00' },
            { id: 2, statusas: 'Live', kodas: 'LED-K1', ekranas: 'Akropolis LED', adresas: 'Karaliaus Mindaugo pr.', rezoliucija: '1280x720', darboLaikas: '07:00 - 23:00' },
        ];

        const TEMPLATES = {
            static: [
                { n: 'Statusas', t: 'FIX' }, { n: 'Kodas', t: 'FIX' }, { n: 'Miestas', t: 'FIX' },
                { n: 'Pardavimų adresas', t: 'FIX' }, { n: 'Tipas', t: 'FIX' }, { n: 'Leidimai nuo', t: 'LIVE' },
                { n: 'Leidimai iki', t: 'LIVE' }, { n: 'Data', t: 'CAL' }, { n: 'Pardavimas', t: 'CONTENT' }
            ],
            led: [
                { n: 'Statusas', t: 'FIX' }, { n: 'Kodas', t: 'FIX' }, { n: 'Ekranas', t: 'FIX' },
                { n: 'Adresas', t: 'FIX' }, { n: 'Rezoliucija', t: 'FIX' }, { n: 'Darbo laikas', t: 'FIX' },
                { n: 'Data', t: 'CAL' }, { n: 'Pardavimas', t: 'CONTENT' }
            ]
        };

        // --- UTILS ---
        function formatDate(date) {
            if (!date) return "";
            const d = new Date(date);
            if (isNaN(d.getTime())) return String(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseHeaderDate(val) {
            if (val instanceof Date) return val;
            if (typeof val === 'number') {
                return new Date((val - 25569) * 86400 * 1000);
            }
            if (typeof val === 'string') {
                const parts = val.split(/[./-]/);
                if (parts.length === 3) {
                    if (parts[0].length === 4) return new Date(parts[0], parts[1]-1, parts[2]);
                    return new Date(parts[2], parts[1]-1, parts[0]);
                }
            }
            const d = new Date(val);
            return isNaN(d.getTime()) ? null : d;
        }

        function initDates() {
            const start = new Date();
            const end = new Date();
            end.setMonth(end.getMonth() + 3);
            selection.dateStart = formatDate(start);
            selection.dateEnd = formatDate(end);
            const dsEl = document.getElementById('dateStart');
            const deEl = document.getElementById('dateEnd');
            if (dsEl) dsEl.value = selection.dateStart;
            if (deEl) deEl.value = selection.dateEnd;
        }

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const error = document.getElementById('login-error');

            if (user === 'Admin' && pass === 'admin123') {
                login('admin');
            } else if (user === 'User' && pass === 'user123') {
                login('user');
            } else {
                error.classList.remove('hidden');
            }
        });

        function login(role) {
            currentUser = role;
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            
            if (role === 'admin') {
                document.getElementById('admin-sidebar').classList.remove('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('user-flow').classList.add('hidden');
                switchAdminTab('static_db');
            } else {
                document.getElementById('admin-sidebar').classList.add('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
                document.getElementById('user-flow').classList.remove('hidden');
                resetWizard();
            }
            lucide.createIcons();
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').classList.add('hidden');
        }

        // --- VEDLIO LOGIKA ---
        function resetWizard() {
            userStep = 1;
            selection = { type: null, dateMode: 'auto', dateStart: formatDate(new Date()), dateEnd: '', file: null };
            initDates();
            updateStepView();
        }

        function setSelection(key, value) {
            selection[key] = value;
            if (key === 'type') {
                document.querySelectorAll('.type-btn').forEach(b => {
                    const icon = b.querySelector('svg, i');
                    const label = b.querySelector('span');
                    
                    if (b.dataset.type === value) {
                        b.classList.add('border-blue-600', 'bg-blue-50', 'shadow-inner');
                        if (icon) { icon.classList.remove('text-slate-200'); icon.classList.add('text-blue-600'); }
                        if (label) { label.classList.remove('text-slate-300'); label.classList.add('text-blue-700'); }
                    } else {
                        b.classList.remove('border-blue-600', 'bg-blue-50', 'shadow-inner');
                        if (icon) { icon.classList.add('text-slate-200'); icon.classList.remove('text-blue-600'); }
                        if (label) { label.classList.add('text-slate-300'); label.classList.remove('text-blue-700'); }
                    }
                });
            }
            validateNext();
        }

        function setDateMode(mode) {
            selection.dateMode = mode;
            const btnAuto = document.getElementById('btn-auto');
            const btnCustom = document.getElementById('btn-custom');
            const inputs = document.querySelectorAll('.date-input');

            if (mode === 'auto') {
                btnAuto.classList.add('border-blue-600', 'bg-blue-50', 'text-blue-700');
                btnAuto.classList.remove('text-slate-300');
                btnCustom.classList.remove('border-blue-600', 'bg-blue-50', 'text-blue-700');
                btnCustom.classList.add('text-slate-300');
                inputs.forEach(i => { i.disabled = true; i.classList.add('border-transparent', 'text-slate-300'); i.classList.remove('border-slate-200', 'focus:border-blue-600'); });
                initDates();
            } else {
                btnCustom.classList.add('border-blue-600', 'bg-blue-50', 'text-blue-700');
                btnCustom.classList.remove('text-slate-300');
                btnAuto.classList.remove('border-blue-600', 'bg-blue-50', 'text-blue-700');
                btnAuto.classList.add('text-slate-300');
                inputs.forEach(i => { i.disabled = false; i.classList.remove('border-transparent', 'text-slate-300'); i.classList.add('border-slate-200', 'focus:border-blue-600'); });
            }
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selection.file = file;
                document.getElementById('file-name').innerText = file.name;
                validateNext();
            }
        });

        function changeStep(dir) {
            userStep += dir;
            updateStepView();
        }

        function updateStepView() {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('hidden'));
            const currentStepEl = document.getElementById(`step-${userStep}`);
            if (currentStepEl) currentStepEl.classList.remove('hidden');

            document.querySelectorAll('.step-indicator').forEach(ind => {
                const stepNum = parseInt(ind.dataset.step);
                const circle = ind.querySelector('div');
                const span = ind.querySelector('span');

                if (userStep > stepNum) {
                    circle.className = "w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-green-500 text-white shadow-xl ring-4 ring-white";
                    circle.innerHTML = '<i data-lucide="check" class="w-6 h-6"></i>';
                } else if (userStep === stepNum) {
                    circle.className = "w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-blue-600 text-white shadow-xl ring-4 ring-white";
                    circle.innerHTML = stepNum;
                    span.classList.add('text-blue-600');
                    span.classList.remove('text-slate-300');
                } else {
                    circle.className = "w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300";
                    circle.innerHTML = stepNum;
                    span.classList.remove('text-blue-600');
                    span.classList.add('text-slate-300');
                }
            });

            const prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.style.visibility = (userStep > 1 && userStep < 5) ? 'visible' : 'hidden';
            }
            
            const wizardNav = document.getElementById('wizard-nav');
            if (wizardNav) {
                wizardNav.classList.toggle('hidden', userStep === 4 || userStep === 5);
            }
            
            const promptEl = document.getElementById('formuoti-prompt');
            const spinEl = document.getElementById('processing-spinner');
            if (promptEl) promptEl.classList.remove('hidden');
            if (spinEl) spinEl.classList.add('hidden');

            validateNext();
            lucide.createIcons();
        }

        function validateNext() {
            const btn = document.getElementById('next-btn');
            if (!btn) return;
            let valid = true;
            if (userStep === 1 && !selection.type) valid = false;
            if (userStep === 3 && !selection.file) valid = false;
            btn.disabled = !valid;
        }

        // --- NUSKAITYMO VARIKLIS ---
        async function startProcessing() {
            document.getElementById('formuoti-prompt').classList.add('hidden');
            document.getElementById('processing-spinner').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    const isStatika = selection.type === 'Statika';
                    
                    // Lapo parinkimas
                    let targetSheetName = isStatika ? workbook.SheetNames[0] : workbook.SheetNames.find(n => n.toLowerCase() === 'led užimtumas' || n.toLowerCase().includes('užimtumas')) || workbook.SheetNames[0];
                    const sheet = workbook.Sheets[targetSheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
                    
                    // Eilutės
                    const headerIdx = isStatika ? 14 : 17;
                    const dataStartRow = isStatika ? 15 : 18; 
                    const dataEndRow = isStatika ? rows.length : Math.min(rows.length, 726);
                    
                    const dateRow = rows[headerIdx]; 
                    const startIdx = 28; // AC
                    const startDateLimit = new Date(document.getElementById('dateStart').value);
                    const endDateLimit = new Date(document.getElementById('dateEnd').value);

                    const resultData = [];
                    let lastEntryBase = null; 

                    for (let i = dataStartRow; i < dataEndRow; i++) {
                        const row = rows[i];
                        if (!row) continue;

                        const triggerIdx = isStatika ? 12 : 2;
                        const cellTrigger = row[triggerIdx] ? String(row[triggerIdx]).trim() : '';
                        
                        if (cellTrigger !== '') {
                            if (isStatika) {
                                lastEntryBase = {
                                    'Statusas': row[1] || '',
                                    'Kodas': row[12] || '',
                                    'Miestas': row[13] || '',
                                    'Pardavimų adresas': row[14] || '',
                                    'Tipas': row[15] || '',
                                    'Leidimai nuo': formatDate(row[25]),
                                    'Leidimai iki': formatDate(row[26]),
                                };
                            } else {
                                lastEntryBase = {
                                    'Statusas': row[0] || '', // A
                                    'Kodas': row[2] || '', // C
                                    'Ekranas': row[3] || '', // D
                                    'Adresas': row[4] || '', // E
                                    'Rezoliucija': row[5] || '', // F
                                    'Darbo laikas': row[6] || '', // G
                                };
                            }
                        }

                        if (!lastEntryBase) continue;

                        for (let j = startIdx; j < dateRow.length; j++) {
                            const rawHeaderDate = dateRow[j];
                            const cellDate = parseHeaderDate(rawHeaderDate);
                            if (!cellDate) continue;

                            if (cellDate >= startDateLimit && cellDate <= endDateLimit) {
                                const content = row[j];
                                if (content !== null && content !== undefined) {
                                    const cleanContent = String(content).trim();
                                    if (cleanContent !== '' && cleanContent !== '0' && cleanContent !== '0.0') {
                                        resultData.push({
                                            ...lastEntryBase,
                                            'Data': formatDate(cellDate),
                                            'Pardavimas': cleanContent
                                        });
                                    }
                                }
                            }
                        }
                    }

                    await new Promise(res => setTimeout(res, 2000));

                    if (resultData.length > 0) {
                        const newSheet = XLSX.utils.json_to_sheet(resultData);
                        const newWorkbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(newWorkbook, newSheet, "Eksportas");
                        XLSX.writeFile(newWorkbook, `Eksportas_${selection.type}_${formatDate(new Date())}.xlsx`);
                        
                        document.getElementById('success-message').innerHTML = `Duomenys suformuoti už laikotarpį: <br><b>${formatDate(startDateLimit)} iki ${formatDate(endDateLimit)}</b><br><small class="opacity-40">Rasta įrašų: ${resultData.length}</small>`;
                        userStep = 5;
                        updateStepView();
                    } else {
                        alert("Užsakymų nerasta pasirinktame intervale.");
                        document.getElementById('formuoti-prompt').classList.remove('hidden');
                        document.getElementById('processing-spinner').classList.add('hidden');
                    }
                } catch (err) {
                    console.error(err);
                    alert("Klaida apdorojant failą.");
                    document.getElementById('formuoti-prompt').classList.remove('hidden');
                    document.getElementById('processing-spinner').classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(selection.file);
        }

        // --- ADMIN DALIS ---
        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.add('bg-slate-800', 'text-white', 'border-l-4', 'border-blue-500', 'shadow-xl');
                    btn.classList.remove('hover:bg-slate-800/50');
                } else {
                    btn.classList.remove('bg-slate-800', 'text-white', 'border-l-4', 'border-blue-500', 'shadow-xl');
                    btn.classList.add('hover:bg-slate-800/50');
                }
            });

            const title = document.getElementById('admin-title');
            const badge = document.getElementById('admin-badge');
            const dbView = document.getElementById('admin-db-view');
            const templateView = document.getElementById('admin-template-view');

            if (tab.includes('_db')) {
                dbView.classList.remove('hidden');
                templateView.classList.add('hidden');
                title.innerText = "Duomenų bazė";
                badge.innerText = tab === 'static_db' ? "STATIKA" : "LED";
                renderDB(tab === 'static_db' ? 'static' : 'led');
            } else {
                dbView.classList.add('hidden');
                templateView.classList.remove('hidden');
                title.innerText = "Eksporto šablonas";
                badge.innerText = tab === 'static_template' ? "STATIKA" : "LED";
                renderTemplate(tab === 'static_template' ? 'static' : 'led');
            }
            lucide.createIcons();
        }

        function renderDB(type) {
            const table = document.getElementById('db-table');
            const data = type === 'static' ? INITIAL_STATIC_DB : INITIAL_LED_DB;
            let html = `<thead><tr class="bg-slate-50 border-b border-slate-100"><th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Statusas</th><th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Kodas</th>`;
            if (type === 'static') {
                html += `<th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Miestas</th><th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Pardavimų adresas</th><th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Tipas</th>`;
            } else {
                html += `<th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Ekranas</th><th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Adresas</th><th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Rezoliucija</th><th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest font-sans">Darbo laikas</th>`;
            }
            html += `<th class="px-10 py-8 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right font-sans">Veiksmai</th></tr></thead><tbody class="divide-y divide-slate-50">`;
            data.forEach(item => {
                html += `<tr class="hover:bg-slate-50 group font-sans font-sans font-sans font-sans font-sans font-sans font-sans"><td class="px-10 py-8 font-sans font-sans font-sans font-sans"><span class="px-4 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest ${item.statusas === 'OK' || item.statusas === 'Live' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'} font-sans font-sans font-sans font-sans">${item.statusas}</span></td><td class="px-10 py-8 font-mono font-black text-blue-600 text-lg tracking-tight font-sans font-sans font-sans font-sans font-sans">${item.kodas}</td>`;
                if (type === 'static') {
                    html += `<td class="px-10 py-8 text-slate-900 font-extrabold uppercase font-sans font-sans">${item.miestas}</td><td class="px-10 py-8 text-slate-500 font-medium text-sm font-sans font-sans font-sans">${item.adresas}</td><td class="px-10 py-8 font-black text-slate-400 text-[11px] uppercase tracking-wider font-sans font-sans font-sans">${item.tipas}</td>`;
                } else {
                    html += `<td class="px-10 py-8 text-slate-900 font-extrabold uppercase font-sans font-sans font-sans font-sans">${item.ekranas}</td><td class="px-10 py-8 text-slate-500 font-medium text-sm font-sans font-sans font-sans font-sans">${item.adresas}</td><td class="px-10 py-8 font-black text-slate-400 text-[11px] uppercase font-sans font-sans font-sans font-sans font-sans">${item.rezoliucija}</td><td class="px-10 py-8 font-mono text-xs font-sans font-sans font-sans font-sans font-sans font-sans">${item.darboLaikas}</td>`;
                }
                html += `<td class="px-10 py-8 text-right opacity-0 group-hover:opacity-100 transition-opacity font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans"><button class="p-3 text-slate-300 hover:text-red-500 font-sans font-sans font-sans font-sans"><i data-lucide="trash-2" class="w-5 h-5 font-sans"></i></button></td></tr>`;
            });
            html += `</tbody>`;
            table.innerHTML = html;
        }

        function renderTemplate(type) {
            const list = document.getElementById('template-list');
            const ruleText = document.getElementById('export-rule-text');
            const template = TEMPLATES[type];
            let html = '';
            template.forEach((col, i) => {
                html += `<div class="flex items-center justify-between p-6 bg-slate-50 rounded-3xl border border-slate-100 group transition-all font-sans font-sans font-sans font-sans font-sans font-sans font-sans"><div class="flex items-center gap-5 font-sans font-sans font-sans font-sans font-sans font-sans font-sans"><span class="text-xs font-black text-blue-600 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center font-sans font-sans font-sans font-sans font-sans font-sans font-sans">${i+1}</span><span class="text-sm font-black text-slate-800 uppercase tracking-tight font-sans font-sans font-sans font-sans font-sans font-sans font-sans">${col.n}</span></div><span class="text-[9px] font-black px-3 py-1.5 rounded-lg shadow-sm ${col.t === 'FIX' ? 'bg-slate-900 text-white font-sans font-sans font-sans font-sans font-sans font-sans font-sans' : col.t === 'CAL' ? 'bg-blue-500 text-white font-sans font-sans font-sans font-sans font-sans font-sans font-sans' : 'bg-white text-slate-500 font-sans font-sans font-sans font-sans font-sans font-sans font-sans'} font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">${col.t}</span></div>`;
            });
            list.innerHTML = html;
            ruleText.innerText = type === 'static' ? "Statika: nuskaitoma nuo 16 iki galo." : "LED: nuskaitomas intervalas nuo 19 iki 726 eilutės lape 'LED užimtumas'. Statusas - A, Kodas - C stulpelyje.";
        }

        window.onload = () => { lucide.createIcons(); initDates(); };
    </script>
</body>
</html>
