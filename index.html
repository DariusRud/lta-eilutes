<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel eilučių formavimas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- PRISIJUNGIMO VAIZDAS -->
        <div id="login-view" class="flex-1 flex items-center justify-center p-8">
            <div class="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl p-12 border border-slate-100">
                <div class="flex flex-col items-center mb-12 text-center">
                    <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tighter font-sans">Prisijungimas</h1>
                </div>
                <form id="login-form" class="space-y-6">
                    <div class="relative group">
                        <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-600 w-5 h-5"></i>
                        <input type="text" id="username" placeholder="Vartotojas" required
                            class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-50/50 outline-none transition-all font-bold text-slate-700 placeholder:text-slate-300 font-sans">
                    </div>
                    <div class="relative group">
                        <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-600 w-5 h-5"></i>
                        <input type="password" id="password" placeholder="Slaptažodis" required
                            class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-50/50 outline-none transition-all font-bold text-slate-700 placeholder:text-slate-300 font-sans">
                    </div>
                    <div id="login-error" class="hidden text-red-500 text-[10px] font-black uppercase text-center tracking-widest animate-pulse font-mono">
                        Neteisingi duomenys
                    </div>
                    <button type="submit" class="w-full bg-slate-900 hover:bg-black text-white font-black py-5 rounded-2xl shadow-xl uppercase tracking-widest text-xs transition-all active:scale-95 font-sans">
                        Prisijungti
                    </button>
                </form>
            </div>
        </div>

        <!-- PAGRINDINIS VAIZDAS -->
        <div id="main-view" class="hidden flex-1 flex h-screen overflow-hidden bg-white">
            <!-- TURINYS -->
            <main class="flex-1 flex flex-col h-screen overflow-y-auto bg-slate-50 font-sans">
                
                <!-- VARTOTOJO VEIKSMŲ SEKA -->
                <div id="user-flow" class="hidden flex-1 flex flex-col items-center justify-center p-8">
                    <div class="w-full max-w-4xl">
                        <!-- PROGRESO JUOSTA -->
                        <div class="mb-20 flex justify-between relative px-10 font-sans">
                            <div class="absolute top-6 left-16 right-16 h-0.5 bg-slate-200 z-0"></div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="1">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-blue-600 text-white shadow-xl ring-4 ring-white">1</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-blue-600">Tipas</span>
                            </div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="2">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300">2</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-300">Data</span>
                            </div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="3">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300">3</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-300">Įkelti</span>
                            </div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300">4</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-300">Formuoti</span>
                            </div>
                            <div class="step-indicator relative z-10 flex flex-col items-center gap-4 font-sans" data-step="5">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300">5</div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-300">Suformuota</span>
                            </div>
                        </div>

                        <!-- KORTELĖ -->
                        <div class="bg-white rounded-[4rem] shadow-2xl p-16 md:p-24 min-h-[550px] flex flex-col border border-slate-100 relative overflow-hidden text-center font-sans">
                            
                            <!-- 1 ŽINGSNIS: TIPAS -->
                            <div id="step-1" class="wizard-step animate-in fade-in slide-in-from-bottom-12 duration-700 flex flex-col justify-center flex-1">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 text-center">
                                    <button onclick="setSelection('type', 'Statika')" class="type-btn p-14 rounded-[3rem] border-4 transition-all flex flex-col items-center justify-center gap-6 group hover:border-blue-100 bg-slate-50/50" data-type="Statika">
                                        <i data-lucide="file-spreadsheet" class="w-14 h-14 text-slate-200 group-hover:text-blue-600 transition-colors"></i>
                                        <span class="font-black text-3xl uppercase tracking-tighter text-slate-300 group-hover:text-blue-700">Statika</span>
                                    </button>
                                    <button onclick="setSelection('type', 'LED')" class="type-btn p-14 rounded-[3rem] border-4 transition-all flex flex-col items-center justify-center gap-6 group hover:border-blue-100 bg-slate-50/50" data-type="LED">
                                        <i data-lucide="monitor" class="w-14 h-14 text-slate-200 group-hover:text-blue-600 transition-colors"></i>
                                        <span class="font-black text-3xl uppercase tracking-tighter text-slate-300 group-hover:text-blue-700">LED</span>
                                    </button>
                                </div>
                            </div>

                            <!-- 2 ŽINGSNIS: DATA -->
                            <div id="step-2" class="wizard-step hidden animate-in fade-in slide-in-from-right-12 duration-700 flex flex-col justify-center flex-1 text-center font-sans">
                                <h2 class="text-3xl font-black text-slate-900 mb-10 uppercase tracking-tighter">Laiko intervalas</h2>
                                <div class="p-10 bg-slate-50 rounded-[3rem] grid grid-cols-2 gap-10 border border-slate-100 text-left">
                                    <div>
                                        <label class="text-[10px] font-black text-slate-400 uppercase mb-4 block tracking-widest font-mono text-left">Pradžia (YYYY-MM-DD)</label>
                                        <input type="date" id="dateStart" onchange="selection.dateStart = this.value" class="date-input w-full bg-transparent border-b-2 outline-none text-2xl font-black py-2 transition-all border-slate-200 focus:border-blue-600 font-sans">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-black text-slate-400 uppercase mb-4 block tracking-widest font-mono text-left">Pabaiga (YYYY-MM-DD)</label>
                                        <input type="date" id="dateEnd" onchange="selection.dateEnd = this.value" class="date-input w-full bg-transparent border-b-2 outline-none text-2xl font-black py-2 transition-all border-slate-200 focus:border-blue-600 font-sans">
                                    </div>
                                </div>
                            </div>

                            <!-- 3 ŽINGSNIS: ĮKELTI -->
                            <div id="step-3" class="wizard-step hidden animate-in fade-in slide-in-from-right-12 duration-700 flex-1 flex flex-col">
                                <h2 class="text-5xl font-black text-slate-900 mb-12 uppercase tracking-tighter">Įkelti failą</h2>
                                <div class="relative group border-4 border-dashed border-slate-100 rounded-[3.5rem] p-24 flex flex-col items-center justify-center bg-slate-50/50 hover:bg-white hover:border-blue-400 transition-all cursor-pointer flex-1">
                                    <input type="file" id="file-input" class="absolute inset-0 opacity-0 cursor-pointer z-10" accept=".xlsx">
                                    <div class="p-10 bg-white rounded-[2.5rem] shadow-xl mb-8 group-hover:scale-110 transition-transform text-blue-600">
                                        <i data-lucide="file-up" class="w-16 h-16"></i>
                                    </div>
                                    <p id="file-name" class="font-black text-slate-900 text-2xl tracking-tight text-center">Įkelkite arba nutempkite Excel failą</p>
                                </div>
                            </div>

                            <!-- 4 ŽINGSNIS: FORMUOTI -->
                            <div id="step-4" class="wizard-step hidden animate-in zoom-in duration-700 flex flex-col items-center justify-center flex-1">
                                <div id="formuoti-prompt">
                                    <button onclick="startProcessing()" class="px-24 py-7 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-[2.5rem] shadow-2xl shadow-blue-200 uppercase tracking-widest text-sm transition-all active:scale-95">Pradėti nuskaitymą</button>
                                </div>
                                <div id="processing-spinner" class="hidden">
                                    <div class="relative w-48 h-48 mx-auto mb-12">
                                        <div class="w-full h-full border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
                                        <div class="absolute inset-0 flex items-center justify-center font-black text-blue-600 uppercase text-xs tracking-tighter font-mono italic">...</div>
                                    </div>
                                    <h3 class="text-3xl font-black text-slate-900 uppercase tracking-tighter">Vyksta nuskaitymas</h3>
                                    <p class="text-slate-400 mt-4 font-bold uppercase tracking-[0.2em] text-[10px]">Formuojamos duomenų eilutės...</p>
                                </div>
                            </div>

                            <!-- 5 ŽINGSNIS: SUFORMUOTA -->
                            <div id="step-5" class="wizard-step hidden animate-in zoom-in duration-700 flex flex-col items-center justify-center flex-1">
                                <div class="w-40 h-40 bg-green-500 text-white rounded-[3rem] flex items-center justify-center mb-12 shadow-2xl shadow-green-200 rotate-6 transition-transform">
                                    <i data-lucide="check-circle-2" class="w-24 h-24"></i>
                                </div>
                                <h2 class="text-5xl font-black text-slate-900 mb-6 uppercase tracking-tighter">SUFORMUOTA</h2>
                                <p id="success-message" class="text-slate-500 mb-10 max-w-sm mx-auto font-medium leading-relaxed"></p>
                                <button onclick="resetWizard()" class="px-10 py-5 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest text-[10px] hover:bg-black transition-all flex items-center gap-3 mx-auto">
                                    <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Naujas nuskaitymas
                                </button>
                            </div>

                            <!-- NAVIGACIJA -->
                            <div id="wizard-nav" class="mt-auto pt-20 flex justify-between items-center border-t border-slate-50">
                                <button onclick="changeStep(-1)" id="prev-btn" class="flex items-center gap-3 font-black uppercase tracking-widest text-xs text-slate-300 hover:text-slate-900 transition-colors invisible">
                                    <i data-lucide="arrow-left" class="w-6 h-6"></i> Atgal
                                </button>
                                <div class="flex items-center gap-6">
                                    <button onclick="handleLogout()" class="text-xs font-black text-slate-300 uppercase hover:text-red-500 transition-colors">Atsijungti</button>
                                    <button onclick="changeStep(1)" id="next-btn" class="bg-slate-900 hover:bg-black text-white font-black px-16 py-6 rounded-[2rem] flex items-center gap-4 shadow-2xl disabled:bg-slate-100 disabled:text-slate-200 transition-all uppercase tracking-widest text-xs">
                                        Toliau <i data-lucide="arrow-right" class="w-6 h-6"></i>
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- DUOMENYS IR BŪSENA ---
        let userStep = 1;
        let selection = {
            type: null,
            dateStart: "2025-01-01",
            dateEnd: "",
            file: null
        };

        // --- PAGALBINĖS FUNKCIJOS ---
        function formatDate(date) {
            if (!date) return "";
            const d = new Date(date);
            if (isNaN(d.getTime())) return String(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseHeaderDate(val) {
            if (val instanceof Date) return val;
            if (typeof val === 'number') {
                return new Date((val - 25569) * 86400 * 1000);
            }
            if (typeof val === 'string') {
                const parts = val.split(/[./-]/);
                if (parts.length === 3) {
                    if (parts[0].length === 4) return new Date(parts[0], parts[1]-1, parts[2]);
                    return new Date(parts[2], parts[1]-1, parts[0]);
                }
            }
            const d = new Date(val);
            return isNaN(d.getTime()) ? null : d;
        }

        function initDates() {
            selection.dateStart = "2025-01-01";
            const end = new Date();
            end.setMonth(end.getMonth() + 3);
            selection.dateEnd = formatDate(end);
            
            const dsEl = document.getElementById('dateStart');
            const deEl = document.getElementById('dateEnd');
            if (dsEl) dsEl.value = selection.dateStart;
            if (deEl) deEl.value = selection.dateEnd;
        }

        // --- PRISIJUNGIMAS ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const error = document.getElementById('login-error');

            const validUsers = [
                { u: 'Admin', p: 'admin123' },
                { u: 'User', p: 'user123' },
                { u: 'LTA', p: 'LT13215202LT' }
            ];

            const isValid = validUsers.some(v => v.u === user && v.p === pass);

            if (isValid) {
                login();
            } else {
                error.classList.remove('hidden');
            }
        });

        function login() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('user-flow').classList.remove('hidden');
            resetWizard();
            lucide.createIcons();
        }

        function handleLogout() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').classList.add('hidden');
        }

        // --- VEDLIO LOGIKA ---
        function resetWizard() {
            userStep = 1;
            selection = { type: null, dateStart: "2025-01-01", dateEnd: "", file: null };
            initDates();
            updateStepView();
        }

        function setSelection(key, value) {
            selection[key] = value;
            if (key === 'type') {
                document.querySelectorAll('.type-btn').forEach(b => {
                    const icon = b.querySelector('svg, i');
                    const label = b.querySelector('span');
                    
                    if (b.dataset.type === value) {
                        b.classList.add('border-blue-600', 'bg-blue-50', 'shadow-inner');
                        if (icon) { icon.classList.remove('text-slate-200'); icon.classList.add('text-blue-600'); }
                        if (label) { label.classList.remove('text-slate-300'); label.classList.add('text-blue-700'); }
                    } else {
                        b.classList.remove('border-blue-600', 'bg-blue-50', 'shadow-inner');
                        if (icon) { icon.classList.add('text-slate-200'); icon.classList.remove('text-blue-600'); }
                        if (label) { label.classList.add('text-slate-300'); label.classList.remove('text-blue-700'); }
                    }
                });
            }
            validateNext();
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selection.file = file;
                document.getElementById('file-name').innerText = file.name;
                validateNext();
            }
        });

        function changeStep(dir) {
            userStep += dir;
            updateStepView();
        }

        function updateStepView() {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('hidden'));
            const currentStepEl = document.getElementById(`step-${userStep}`);
            if (currentStepEl) currentStepEl.classList.remove('hidden');

            document.querySelectorAll('.step-indicator').forEach(ind => {
                const stepNum = parseInt(ind.dataset.step);
                const circle = ind.querySelector('div');
                const span = ind.querySelector('span');

                if (userStep > stepNum) {
                    circle.className = "w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-green-500 text-white shadow-xl ring-4 ring-white";
                    circle.innerHTML = '<i data-lucide="check" class="w-6 h-6"></i>';
                } else if (userStep === stepNum) {
                    circle.className = "w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-blue-600 text-white shadow-xl ring-4 ring-white";
                    circle.innerHTML = stepNum;
                    span.classList.add('text-blue-600');
                    span.classList.remove('text-slate-300');
                } else {
                    circle.className = "w-12 h-12 rounded-full flex items-center justify-center font-black text-sm transition-all bg-white border-2 border-slate-200 text-slate-300";
                    circle.innerHTML = stepNum;
                    span.classList.remove('text-blue-600');
                    span.classList.add('text-slate-300');
                }
            });

            const prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.style.visibility = (userStep > 1 && userStep < 5) ? 'visible' : 'hidden';
            }
            
            const wizardNav = document.getElementById('wizard-nav');
            if (wizardNav) {
                wizardNav.classList.toggle('hidden', userStep === 4 || userStep === 5);
            }
            
            const promptEl = document.getElementById('formuoti-prompt');
            const spinEl = document.getElementById('processing-spinner');
            if (promptEl) promptEl.classList.remove('hidden');
            if (spinEl) spinEl.classList.add('hidden');

            validateNext();
            lucide.createIcons();
        }

        function validateNext() {
            const btn = document.getElementById('next-btn');
            if (!btn) return;
            let valid = true;
            if (userStep === 1 && !selection.type) valid = false;
            if (userStep === 3 && !selection.file) valid = false;
            btn.disabled = !valid;
        }

        // --- APDOROJIMO VARIKLIS ---
        async function startProcessing() {
            document.getElementById('formuoti-prompt').classList.add('hidden');
            document.getElementById('processing-spinner').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    const isStatika = selection.type === 'Statika';
                    let targetSheetName = isStatika ? workbook.SheetNames[0] : workbook.SheetNames.find(n => n.toLowerCase() === 'led užimtumas' || n.toLowerCase().includes('užimtumas')) || workbook.SheetNames[0];
                    const sheet = workbook.Sheets[targetSheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
                    
                    const headerIdx = isStatika ? 14 : 17;
                    const dataStartRow = isStatika ? 15 : 18; 
                    const dataEndRow = isStatika ? rows.length : Math.min(rows.length, 726);
                    
                    const dateRow = rows[headerIdx]; 
                    const startIdx = 28; // AC stulpelis
                    const startDateLimit = new Date(document.getElementById('dateStart').value);
                    const endDateLimit = new Date(document.getElementById('dateEnd').value);

                    const resultData = [];
                    let lastEntryBase = null; 

                    for (let i = dataStartRow; i < dataEndRow; i++) {
                        const row = rows[i];
                        if (!row) continue;

                        const triggerIdx = isStatika ? 12 : 2;
                        const cellTrigger = row[triggerIdx] ? String(row[triggerIdx]).trim() : '';
                        
                        if (cellTrigger !== '') {
                            if (isStatika) {
                                lastEntryBase = {
                                    'Statusas': row[1] || '', 'Kodas': row[12] || '', 'Miestas': row[13] || '',
                                    'Pardavimų adresas': row[14] || '', 'Tipas': row[15] || '',
                                    'Leidimai nuo': formatDate(row[25]), 'Leidimai iki': formatDate(row[26]),
                                };
                            } else {
                                lastEntryBase = {
                                    'Statusas': row[0] || '', 'Kodas': row[2] || '', 'Ekranas': row[3] || '',
                                    'Adresas': row[4] || '', 'Rezoliucija': row[5] || '', 'Darbo laikas': row[6] || '',
                                };
                            }
                        }

                        if (!lastEntryBase) continue;

                        for (let j = startIdx; j < dateRow.length; j++) {
                            const rawHeaderDate = dateRow[j];
                            const cellDate = parseHeaderDate(rawHeaderDate);
                            if (!cellDate) continue;

                            if (cellDate >= startDateLimit && cellDate <= endDateLimit) {
                                const content = row[j];
                                if (content !== null && content !== undefined) {
                                    const cleanContent = String(content).trim();
                                    if (cleanContent !== '' && cleanContent !== '0' && cleanContent !== '0.0') {
                                        const formattedDate = formatDate(cellDate);
                                        
                                        // Pridedame 'Kiekis': 1 tiek Statikai, tiek LED
                                        resultData.push({ 
                                            ...lastEntryBase, 
                                            'Data': formattedDate, 
                                            'Pardavimas': cleanContent,
                                            'Kiekis': 1
                                        });
                                    }
                                }
                            }
                        }
                    }

                    const finalOutput = resultData;

                    await new Promise(res => setTimeout(res, 2000));

                    if (finalOutput.length > 0) {
                        const newSheet = XLSX.utils.json_to_sheet(finalOutput);
                        const newWorkbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(newWorkbook, newSheet, "Eksportas");
                        XLSX.writeFile(newWorkbook, `Eksportas_${selection.type}_${formatDate(new Date())}.xlsx`);
                        
                        document.getElementById('success-message').innerHTML = `Duomenys suformuoti už laikotarpį: <br><b>${formatDate(startDateLimit)} iki ${formatDate(endDateLimit)}</b><br><small class="opacity-40 font-sans">Eilučių sugeneruota: ${finalOutput.length}</small>`;
                        userStep = 5;
                        updateStepView();
                    } else {
                        alert("Užsakymų nerasta pasirinktame intervale.");
                        updateStepView();
                    }
                } catch (err) {
                    console.error(err);
                    alert("Klaida apdorojant failą.");
                    updateStepView();
                }
            };
            reader.readAsArrayBuffer(selection.file);
        }

        window.onload = () => { lucide.createIcons(); initDates(); };
    </script>
</body>
</html>
